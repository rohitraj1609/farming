{% extends "base.html" %}

{% block title %}Market Updates - Farming App{% endblock %}

{% block head_extra %}
<script>
// Pass user data to the base template
console.log('Setting user data in sessionStorage...');
console.log('User email:', '{{ user_email or "user@example.com" }}');
console.log('User name:', '{{ user_name or "User" }}');

// Store user data in sessionStorage for the base template
sessionStorage.setItem('userEmail', '{{ user_email or "user@example.com" }}');
sessionStorage.setItem('userPhone', '{{ user_phone or "" }}');
sessionStorage.setItem('userName', '{{ user_name or "User" }}');
sessionStorage.setItem('userLocation', '{{ user_location or "" }}');
sessionStorage.setItem('userBio', '{{ user_bio or "" }}');

console.log('User data stored:', {
    email: sessionStorage.getItem('userEmail'),
    name: sessionStorage.getItem('userName'),
    phone: sessionStorage.getItem('userPhone')
});

// Force navigation update after setting user data
setTimeout(() => {
    console.log('Forcing navigation update after user data is set...');
    if (typeof updateNavigation === 'function') {
        console.log('Calling updateNavigation...');
        updateNavigation();
    } else {
        console.log('updateNavigation function not available yet, trying again...');
        setTimeout(() => {
            if (typeof updateNavigation === 'function') {
                updateNavigation();
            }
        }, 200);
    }
}, 50);
</script>
{% endblock %}

{% block content %}
<div class="market-page">
    <!-- Page Header -->
    <div class="page-header">
        <div class="header-content">
            <h1 data-translate="market.title">üìä Market Updates</h1>
            <p data-translate="market.subtitle">Stay informed with latest agricultural market trends</p>
        </div>
    </div>

    <!-- Search Bar -->
    <div class="search-container">
        <div class="search-wrapper">
            <input type="text" placeholder="Search market news..." class="search-input" data-translate="market.search">
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons-section">
        <div class="action-buttons-container">
            <a href="/market" class="action-btn market-btn active">
                <span class="btn-icon">üìä</span>
                <span class="btn-text" data-translate="actions.marketUpdates">Market Updates</span>
            </a>
            <a href="/sell" class="action-btn sell-btn">
                <span class="btn-icon">üåæ</span>
                <span class="btn-text" data-translate="actions.sellCrops">Sell Crops</span>
            </a>
            <a href="/buy" class="action-btn buy-btn">
                <span class="btn-icon">üõí</span>
                <span class="btn-text" data-translate="actions.buyCrops">Buy Crops</span>
            </a>
        </div>
    </div>

    <!-- Market Overview Cards -->
    <div class="market-overview">
        <div class="overview-card">
            <div class="card-icon">üìà</div>
            <div class="card-content">
                <h3 data-translate="market.wheatPrice">Wheat Price</h3>
                <div class="price">‚Çπ2,450/Quintal</div>
                <div class="change positive">+5.2%</div>
            </div>
        </div>
        
        <div class="overview-card">
            <div class="card-icon">üåΩ</div>
            <div class="card-content">
                <h3 data-translate="market.cornPrice">Corn Price</h3>
                <div class="price">‚Çπ1,850/Quintal</div>
                <div class="change positive">+2.8%</div>
            </div>
        </div>
        
        <div class="overview-card">
            <div class="card-icon">üçÖ</div>
            <div class="card-content">
                <h3 data-translate="market.tomatoPrice">Tomato Price</h3>
                <div class="price">‚Çπ45/kg</div>
                <div class="change negative">-3.1%</div>
            </div>
        </div>
        
        <div class="overview-card">
            <div class="card-icon">ü•ï</div>
            <div class="card-content">
                <h3 data-translate="market.carrotPrice">Carrot Price</h3>
                <div class="price">‚Çπ35/kg</div>
                <div class="change positive">+1.5%</div>
            </div>
        </div>
    </div>

    <!-- Latest News Section -->
    <div class="market-news-section">
        <div class="market-news-header">
            <h2 data-translate="market.latestNews">üìà Latest Market News</h2>
            <button class="refresh-btn" onclick="refreshNews()" data-translate="market.refresh">üîÑ Refresh</button>
        </div>
        <div class="market-news-content" id="market-news-content">
            <!-- Market updates will be loaded here from database -->
            {% for update in market_updates %}
            <div class="news-item" data-update-id="{{ update._id }}">
                <div class="news-header">
                    <div class="news-time">
                        {% if update.created_at %}
                            {{ update.created_at.strftime('%H:%M') }}
                        {% else %}
                            <span data-translate="market.unknownTime">Unknown time</span>
                        {% endif %}
                    </div>
                    <div class="news-author">üë§ {{ update.author }}</div>
                </div>
                <div class="news-title">{{ update.title }}</div>
                <div class="news-summary">{{ update.description }}</div>
                <div class="news-tags">
                    <span class="tag">{{ update.category }}</span>
                    <span class="tag {% if update.impact == 'positive' %}positive{% elif update.impact == 'negative' %}negative{% else %}neutral{% endif %}">
                        {% if update.impact == 'positive' %}üìà <span data-translate="market.positiveImpact">Positive Impact</span>{% elif update.impact == 'negative' %}üìâ <span data-translate="market.negativeImpact">Negative Impact</span>{% else %}‚û°Ô∏è <span data-translate="market.neutralImpact">Neutral Impact</span>{% endif %}
                    </span>
                    {% if update.source %}<span class="tag"><span data-translate="market.source">Source:</span> {{ update.source }}</span>{% endif %}
                </div>
                {% if update.author_email == user_email %}
                <div class="news-actions">
                    <button class="btn-edit-news" onclick="editMarketUpdate('{{ update._id }}')">‚úèÔ∏è <span data-translate="common.edit">Edit</span></button>
                    <button class="btn-delete-news" onclick="deleteMarketUpdate('{{ update._id }}')">üóëÔ∏è <span data-translate="common.delete">Delete</span></button>
                </div>
                {% endif %}
            </div>
            {% endfor %}
            
            <!-- Default news if no database updates -->
            {% if not market_updates %}
            <div class="news-item featured">
                <div class="news-header">
                    <div class="news-time">2 hours ago</div>
                    <div class="news-author">üë§ System</div>
                </div>
                <div class="news-title">Wheat prices rise 5% due to weather concerns</div>
                <div class="news-summary">Heavy rainfall in northern regions affects wheat harvest, driving prices up. Farmers are advised to monitor weather forecasts closely.</div>
                <div class="news-tags">
                    <span class="tag">price</span>
                    <span class="tag positive">üìà Positive Impact</span>
                    <span class="tag">Source: Weather Report</span>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Market Analysis Section -->
    <div class="market-analysis">
        <h2 data-translate="market.analysis">üìä Market Analysis</h2>
        <div class="analysis-grid">
            <div class="analysis-card">
                <h3 data-translate="market.priceTrends">Price Trends</h3>
                <div class="trend-chart">
                    <div class="chart-placeholder">
                        üìà Price trend chart would be here
                    </div>
                </div>
            </div>
            
            <div class="analysis-card">
                <h3 data-translate="market.demandForecast">Demand Forecast</h3>
                <div class="forecast-data">
                    <div class="forecast-item">
                        <span class="crop">Wheat</span>
                        <span class="forecast" data-translate="market.highDemand">High Demand</span>
                    </div>
                    <div class="forecast-item">
                        <span class="crop">Rice</span>
                        <span class="forecast" data-translate="market.stable">Stable</span>
                    </div>
                    <div class="forecast-item">
                        <span class="crop">Tomato</span>
                        <span class="forecast" data-translate="market.growing">Growing</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Add Button -->
    <div class="floating-add-btn" onclick="showAddMarketUpdateModal()">
        <span class="add-icon">+</span>
    </div>

    <!-- Add Market Update Modal -->
    <div class="modal-overlay" id="add-market-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-translate="market.addUpdate">üìä Add Market Update</h3>
                <button class="close-btn" onclick="closeAddMarketModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="add-market-form">
                    <div class="form-group">
                        <label for="update-title" data-translate="market.updateTitle">Update Title</label>
                        <input type="text" id="update-title" placeholder="Enter update title" data-translate="market.updateTitlePlaceholder" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="update-category" data-translate="market.updateCategory">Category</label>
                        <select id="update-category" required>
                            <option value="" data-translate="market.selectCategory">Select Category</option>
                            <option value="price" data-translate="market.priceUpdate">Price Update</option>
                            <option value="weather" data-translate="market.weatherImpact">Weather Impact</option>
                            <option value="demand" data-translate="market.demandSupply">Demand & Supply</option>
                            <option value="policy" data-translate="market.governmentPolicy">Government Policy</option>
                            <option value="technology" data-translate="market.technology">Technology</option>
                            <option value="export" data-translate="market.exportImport">Export/Import</option>
                            <option value="other" data-translate="market.other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="update-description" data-translate="market.description">Description</label>
                        <textarea id="update-description" placeholder="Describe the market update in detail..." data-translate="market.descriptionPlaceholder" rows="4" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="update-impact" data-translate="market.marketImpact">Market Impact</label>
                        <select id="update-impact">
                            <option value="positive" data-translate="market.positiveImpact">Positive Impact</option>
                            <option value="negative" data-translate="market.negativeImpact">Negative Impact</option>
                            <option value="neutral" data-translate="market.neutralImpact">Neutral Impact</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="update-source" data-translate="market.sourceOptional">Source (Optional)</label>
                        <input type="text" id="update-source" placeholder="e.g., Government Report, News Agency" data-translate="market.sourcePlaceholder">
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn-cancel" onclick="closeAddMarketModal()" data-translate="common.cancel">Cancel</button>
                        <button type="submit" class="btn-submit" data-translate="market.addUpdateBtn">Add Update</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function refreshNews() {
    const refreshBtn = document.querySelector('.refresh-btn');
    const currentLang = localStorage.getItem('appLanguage') || 'en';
    const refreshingText = currentLang === 'hi' ? 'üîÑ ‡§§‡§æ‡§ú‡§º‡§æ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...' : 'üîÑ Refreshing...';
    const refreshText = currentLang === 'hi' ? 'üîÑ ‡§§‡§æ‡§ú‡§º‡§æ ‡§ï‡§∞‡•á‡§Ç' : 'üîÑ Refresh';
    refreshBtn.textContent = refreshingText;
    refreshBtn.disabled = true;
    
    // Simulate API call
    setTimeout(() => {
        refreshBtn.textContent = refreshText;
        refreshBtn.disabled = false;
        const alertText = currentLang === 'hi' ? '‡§¨‡§æ‡§ú‡§æ‡§∞ ‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞ ‡§§‡§æ‡§ú‡§º‡§æ ‡§π‡•ã ‡§ó‡§Ø‡§æ!' : 'Market news refreshed!';
        alert(alertText);
    }, 2000);
}

function showAddMarketUpdateModal() {
    const modal = document.getElementById('add-market-modal');
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden'; // Prevent background scrolling
}

function closeAddMarketModal() {
    const modal = document.getElementById('add-market-modal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto'; // Restore scrolling
}


function addMarketUpdateToPage(update) {
    const newsContent = document.querySelector('.market-news-content');
    const newItem = document.createElement('div');
    newItem.className = 'news-item';
    newItem.setAttribute('data-update-id', update.id);
    
    // Determine impact color
    let impactClass = '';
    let impactText = '';
    if (update.impact === 'positive') {
        impactClass = 'positive';
        impactText = 'üìà Positive Impact';
    } else if (update.impact === 'negative') {
        impactClass = 'negative';
        impactText = 'üìâ Negative Impact';
    } else {
        impactClass = 'neutral';
        impactText = '‚û°Ô∏è Neutral Impact';
    }
    
    // Check if current user is the author
    const currentUserEmail = sessionStorage.getItem('userEmail');
    const isAuthor = update.authorEmail === currentUserEmail;
    
    newItem.innerHTML = `
        <div class="news-header">
            <div class="news-time">${update.timestamp}</div>
            <div class="news-author">üë§ ${update.author}</div>
        </div>
        <div class="news-title">${update.title}</div>
        <div class="news-summary">${update.description}</div>
        <div class="news-tags">
            <span class="tag">${update.category}</span>
            <span class="tag ${impactClass}">${impactText}</span>
            ${update.source ? `<span class="tag">Source: ${update.source}</span>` : ''}
        </div>
        ${isAuthor ? `
            <div class="news-actions">
                <button class="btn-edit-news" onclick="editMarketUpdate(${update.id})">‚úèÔ∏è Edit</button>
                <button class="btn-delete-news" onclick="deleteMarketUpdate(${update.id})">üóëÔ∏è Delete</button>
            </div>
        ` : ''}
    `;
    
    // Insert at the top of news
    newsContent.insertBefore(newItem, newsContent.firstChild);
}

// Close modal when clicking outside
document.getElementById('add-market-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeAddMarketModal();
    }
});

// Edit market update
function editMarketUpdate(updateId) {
    const newsItem = document.querySelector(`[data-update-id="${updateId}"]`);
    if (!newsItem) return;
    
    // Get current values
    const title = newsItem.querySelector('.news-title').textContent;
    const description = newsItem.querySelector('.news-summary').textContent;
    const category = newsItem.querySelector('.tag').textContent;
    const impact = newsItem.querySelector('.tag.positive, .tag.negative, .tag.neutral');
    const source = newsItem.querySelector('.tag:last-child')?.textContent.replace('Source: ', '') || '';
    
    // Pre-fill the form
    document.getElementById('update-title').value = title;
    document.getElementById('update-category').value = category.toLowerCase();
    document.getElementById('update-description').value = description;
    document.getElementById('update-source').value = source;
    
    // Determine impact value
    if (impact.classList.contains('positive')) {
        document.getElementById('update-impact').value = 'positive';
    } else if (impact.classList.contains('negative')) {
        document.getElementById('update-impact').value = 'negative';
    } else {
        document.getElementById('update-impact').value = 'neutral';
    }
    
    // Show modal
    showAddMarketUpdateModal();
    
    // Store the update ID for editing
    document.getElementById('add-market-form').setAttribute('data-editing-id', updateId);
}

// Delete market update
function deleteMarketUpdate(updateId) {
    if (confirm('Are you sure you want to delete this market update?')) {
        deleteMarketUpdateAPI(updateId);
    }
}

// Update form submission to handle editing
document.getElementById('add-market-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const editingId = this.getAttribute('data-editing-id');
    const title = document.getElementById('update-title').value;
    const category = document.getElementById('update-category').value;
    const description = document.getElementById('update-description').value;
    const impact = document.getElementById('update-impact').value;
    const source = document.getElementById('update-source').value;
    
    if (editingId) {
        // Editing existing update
        updateMarketUpdateAPI(editingId, {
            title: title,
            category: category,
            description: description,
            impact: impact,
            source: source
        });
    } else {
        // Creating new update
        addMarketUpdateAPI({
            title: title,
            category: category,
            description: description,
            impact: impact,
            source: source
        });
    }
    
    // Close modal and reset form
    closeAddMarketModal();
    document.getElementById('add-market-form').reset();
});

// API Functions
async function addMarketUpdateAPI(updateData) {
    try {
        const response = await fetch('/api/market-updates', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(updateData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            addMarketUpdateToPage(result.update);
            alert('Market update added successfully!');
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        console.error('Error adding market update:', error);
        alert('Error adding market update. Please try again.');
    }
}

async function updateMarketUpdateAPI(updateId, updateData) {
    try {
        const response = await fetch(`/api/market-updates/${updateId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(updateData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Reload the page to show updated data
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        console.error('Error updating market update:', error);
        alert('Error updating market update. Please try again.');
    }
}

async function deleteMarketUpdateAPI(updateId) {
    try {
        const response = await fetch(`/api/market-updates/${updateId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Remove from page
            const newsItem = document.querySelector(`[data-update-id="${updateId}"]`);
            if (newsItem) {
                newsItem.remove();
            }
            alert('Market update deleted successfully!');
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        console.error('Error deleting market update:', error);
        alert('Error deleting market update. Please try again.');
    }
}
</script>
{% endblock %}
