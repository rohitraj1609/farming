{% extends "base.html" %}

{% block title %}CropMarket - Farming App{% endblock %}

{% block head_extra %}
<script>
// Pass user data to the base template
console.log('Setting user data in sessionStorage...');
console.log('User email:', '{{ user_email or "user@example.com" }}');
console.log('User name:', '{{ user_name or "User" }}');

// Store user data in sessionStorage for the base template
sessionStorage.setItem('userEmail', '{{ user_email or "user@example.com" }}');
sessionStorage.setItem('userPhone', '{{ user_phone or "" }}');
sessionStorage.setItem('userName', '{{ user_name or "User" }}');
sessionStorage.setItem('userLocation', '{{ user_location or "" }}');
sessionStorage.setItem('userBio', '{{ user_bio or "" }}');

console.log('User data stored:', {
    email: sessionStorage.getItem('userEmail'),
    name: sessionStorage.getItem('userName'),
    phone: sessionStorage.getItem('userPhone')
});

// Force navigation update after setting user data
setTimeout(() => {
    console.log('Forcing navigation update after user data is set...');
    if (typeof updateNavigation === 'function') {
        console.log('Calling updateNavigation...');
        updateNavigation();
    } else {
        console.log('updateNavigation function not available yet, trying again...');
        setTimeout(() => {
            if (typeof updateNavigation === 'function') {
                updateNavigation();
            }
        }, 200);
    }
}, 50);
</script>
{% endblock %}

{% block content %}
<div class="booking-page">
    <!-- Search Bar -->
    <div class="search-container">
        <div class="search-wrapper">
            <input type="text" placeholder="Search crops..." class="search-input">
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
        <button class="tab-btn active" onclick="switchTab('sell')" id="sell-tab">üåæ Sell Crops</button>
        <button class="tab-btn" onclick="switchTab('buy')" id="buy-tab">üõí Buy Crops</button>
    </div>

    <!-- Instagram-style Feed -->
    <div class="insta-feed">
        <!-- Stories Section -->
        <div class="stories-section">
            <div class="story-item add-story">
                <div class="story-avatar">
                    <span>+</span>
                </div>
                <span class="story-name">Your Story</span>
            </div>
            <div class="story-item">
                <div class="story-avatar">
                    <span>üåæ</span>
                </div>
                <span class="story-name">Wheat</span>
            </div>
            <div class="story-item">
                <div class="story-avatar">
                    <span>üåΩ</span>
                </div>
                <span class="story-name">Corn</span>
            </div>
            <div class="story-item">
                <div class="story-avatar">
                    <span>üçÖ</span>
                </div>
                <span class="story-name">Tomatoes</span>
            </div>
            <div class="story-item">
                <div class="story-avatar">
                    <span>ü•ï</span>
                </div>
                <span class="story-name">Carrots</span>
            </div>
        </div>

        <!-- Sell Tab Content -->
        <div class="tab-content" id="sell-content">
            <!-- Sell Form Card -->
            <div class="service-card sell-card">
                <div class="card-header">
                    <div class="user-info">
                        <div class="user-avatar">üåæ</div>
                        <div class="user-details">
                            <span class="username">List Your Crop</span>
                            <span class="location">Sell Your Harvest</span>
                        </div>
                    </div>
                </div>
                
                <div class="sell-form-content">
                    <form id="sell-form" class="sell-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="crop_type">Crop Type</label>
                                <select id="crop_type" required>
                                    <option value="">Select Crop</option>
                                    <option value="wheat">Wheat</option>
                                    <option value="rice">Rice</option>
                                    <option value="corn">Corn</option>
                                    <option value="tomatoes">Tomatoes</option>
                                    <option value="potatoes">Potatoes</option>
                                    <option value="carrots">Carrots</option>
                                    <option value="onions">Onions</option>
                                    <option value="spinach">Spinach</option>
                                    <option value="cabbage">Cabbage</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="quantity">Quantity (kg)</label>
                                <input type="number" id="quantity" placeholder="Enter quantity" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="price_per_kg">Price per kg (‚Çπ)</label>
                                <input type="number" id="price_per_kg" placeholder="Enter price per kg" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="harvest_date">Harvest Date</label>
                                <input type="date" id="harvest_date" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="location">Farm Location</label>
                            <input type="text" id="location" placeholder="Enter your farm location" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="description">Crop Description</label>
                            <textarea id="description" placeholder="Describe your crop quality, organic status, etc..." rows="3"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="contact">Contact Number</label>
                            <input type="tel" id="contact" placeholder="Your contact number" required>
                        </div>
                        
                        <div class="total-price" id="total-price">Total Value: ‚Çπ0</div>
                        
                        <button type="button" id="list-crop-button" class="list-button">List My Crop</button>
                    </form>
                </div>
            </div>

            <!-- Success Message Card -->
            <div class="service-card success-card" id="sell-success-card" style="display: none;">
                <div class="card-header">
                    <div class="user-info">
                        <div class="user-avatar">‚úÖ</div>
                        <div class="user-details">
                            <span class="username">Crop Listed Successfully</span>
                            <span class="location">Your crop is now live!</span>
                        </div>
                    </div>
                </div>
                
                <div class="success-content">
                    <div class="success-icon">üéâ</div>
                    <h3>Crop Listed Successfully!</h3>
                    <p>Your crop listing is now live and visible to buyers. You'll be notified when someone is interested.</p>
                </div>
            </div>

            <!-- My Listings Section -->
            <div class="service-card my-listings-card">
                <div class="card-header">
                    <div class="user-info">
                        <div class="user-avatar">üìã</div>
                        <div class="user-details">
                            <span class="username">My Crop Listings</span>
                            <span class="location">Your active listings</span>
                        </div>
                    </div>
                    <button class="refresh-btn" onclick="refreshMyListings()">üîÑ Refresh</button>
                </div>
                
                <div class="my-listings-content">
                    <div class="my-listings-grid" id="my-listings-grid">
                        <!-- User's own crops will be displayed here -->
                    </div>
                    <div class="no-listings" id="no-listings" style="display: none;">
                        <div class="no-listings-icon">üå±</div>
                        <h3>No Listings Yet</h3>
                        <p>You haven't listed any crops yet. Use the form above to list your first crop!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Buy Tab Content -->
        <div class="tab-content" id="buy-content" style="display: none;">
            <!-- Available Crops List -->
            <div class="crops-grid" id="crops-grid">
                <!-- Crop cards will be dynamically generated here -->
            </div>
        </div>
    </div>
</div>

<script>
// Initialize user data from backend
document.addEventListener('DOMContentLoaded', function() {
    // Store user data in sessionStorage
    sessionStorage.setItem('userEmail', '{{ user_email or "user@example.com" }}');
    sessionStorage.setItem('userPhone', '{{ user_phone or "" }}');
    sessionStorage.setItem('userName', '{{ user_name or "User" }}');
    sessionStorage.setItem('userLocation', '{{ user_location or "" }}');
    sessionStorage.setItem('userBio', '{{ user_bio or "" }}');
    
    // Initialize profile display
    if (typeof updateProfileInitials === 'function') {
        updateProfileInitials('{{ user_name or "User" }}');
    }
});
</script>
{% endblock %}

{% block modals %}
<!-- Modals are defined in base.html to avoid duplicate IDs -->
{% endblock %}
