{% extends "base.html" %}

{% block title %}Buy Crops - Farming App{% endblock %}

{% block head_extra %}
<script>
// Pass user data to the base template
console.log('Setting user data in sessionStorage...');
console.log('User email:', '{{ user_email or "user@example.com" }}');
console.log('User name:', '{{ user_name or "User" }}');

// Store user data in sessionStorage for the base template
sessionStorage.setItem('userEmail', '{{ user_email or "user@example.com" }}');
sessionStorage.setItem('userPhone', '{{ user_phone or "" }}');
sessionStorage.setItem('userName', '{{ user_name or "User" }}');
sessionStorage.setItem('userLocation', '{{ user_location or "" }}');
sessionStorage.setItem('userBio', '{{ user_bio or "" }}');

console.log('User data stored:', {
    email: sessionStorage.getItem('userEmail'),
    name: sessionStorage.getItem('userName'),
    phone: sessionStorage.getItem('userPhone')
});

// Force navigation update after setting user data
setTimeout(() => {
    console.log('Forcing navigation update after user data is set...');
    if (typeof updateNavigation === 'function') {
        console.log('Calling updateNavigation...');
        updateNavigation();
    } else {
        console.log('updateNavigation function not available yet, trying again...');
        setTimeout(() => {
            if (typeof updateNavigation === 'function') {
                updateNavigation();
            }
        }, 200);
    }
}, 50);
</script>
{% endblock %}

{% block content %}
<div class="buy-page">
    <!-- Page Header -->
    <div class="page-header">
        <div class="header-content">
            <h1 data-translate="buy.title">üõí Buy Crops</h1>
            <p data-translate="buy.subtitle">Find and purchase fresh crops from local farmers</p>
        </div>
    </div>


    <!-- Action Buttons -->
    <div class="action-buttons-section">
        <div class="action-buttons-container">
            <a href="/market" class="action-btn market-btn">
                <span class="btn-icon">üìä</span>
                <span class="btn-text" data-translate="actions.marketUpdates">Market Updates</span>
            </a>
            <a href="/sell" class="action-btn sell-btn">
                <span class="btn-icon">üåæ</span>
                <span class="btn-text" data-translate="actions.sellCrops">Sell Crops</span>
            </a>
            <a href="/buy" class="action-btn buy-btn active">
                <span class="btn-icon">üõí</span>
                <span class="btn-text" data-translate="actions.buyCrops">Buy Crops</span>
            </a>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
        <div class="filter-container">
            <div class="filter-group">
                <label data-translate="buy.category">Category:</label>
                <select id="category-filter">
                    <option value="" data-translate="buy.allCrops">All Crops</option>
                    <option value="grains" data-translate="buy.grains">Grains</option>
                    <option value="vegetables" data-translate="buy.vegetables">Vegetables</option>
                    <option value="fruits" data-translate="buy.fruits">Fruits</option>
                    <option value="spices" data-translate="buy.spices">Spices</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label data-translate="buy.priceRange">Price Range:</label>
                <select id="price-filter">
                    <option value="" data-translate="buy.anyPrice">Any Price</option>
                    <option value="0-25">‚Çπ0 - ‚Çπ25/kg</option>
                    <option value="25-50">‚Çπ25 - ‚Çπ50/kg</option>
                    <option value="50-100">‚Çπ50 - ‚Çπ100/kg</option>
                    <option value="100+">‚Çπ100+/kg</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label data-translate="buy.location">Location:</label>
                <select id="location-filter">
                    <option value="" data-translate="buy.allLocations">All Locations</option>
                    <option value="punjab">Punjab</option>
                    <option value="haryana">Haryana</option>
                    <option value="maharashtra">Maharashtra</option>
                    <option value="karnataka">Karnataka</option>
                </select>
            </div>
            
            <button class="filter-btn" onclick="applyFilters()" data-translate="buy.applyFilters">Apply Filters</button>
        </div>
    </div>

    <!-- Crop Listings -->
    <div class="crop-listings">
        <h2 data-translate="buy.availableCrops">Available Crops</h2>
        <div class="listings-grid">
            {% if crops %}
                {% for crop in crops %}
                <div class="crop-card {% if crop.seller_email == user_email %}own-listing{% endif %} {% if not crop.is_active or crop.quantity == 0 %}sold-out{% endif %}">
                    {% if crop.seller_email == user_email %}
                    <div class="listing-badge" data-translate="buy.yourListing">Your Listing</div>
                    {% endif %}
                    {% if not crop.is_active or crop.quantity == 0 %}
                    <div class="sold-out-badge">SOLD OUT</div>
                    {% endif %}
                    <div class="crop-image">
                        <span class="crop-icon">
                            {% if crop.category == 'grains' %}üåæ
                            {% elif crop.category == 'vegetables' %}ü•ï
                            {% elif crop.category == 'fruits' %}üçé
                            {% elif crop.category == 'spices' %}üå∂Ô∏è
                            {% else %}üå±
                            {% endif %}
                        </span>
                    </div>
                    <div class="crop-info">
                        <h3>{{ crop.name }}</h3>
                        <p class="farmer"><span data-translate="buy.by">By:</span> {{ crop.seller_name }}</p>
                        <p class="location">üìç {{ crop.location }}</p>
                        <div class="crop-details">
                            {% if crop.quantity == 0 or not crop.is_active %}
                            <span class="quantity sold-out-text"><span data-translate="buy.soldOut">Sold Out</span></span>
                            {% else %}
                            <span class="quantity">{{ crop.quantity }} <span data-translate="buy.kgAvailable">kg available</span></span>
                            {% endif %}
                            <span class="harvest-date">
                                {% if crop.created_at %}
                                    <span data-translate="buy.listed">Listed:</span> {{ crop.created_at.strftime('%d %b %Y') }}
                                {% else %}
                                    <span data-translate="buy.recentlyListed">Recently listed</span>
                                {% endif %}
                            </span>
                        </div>
                        <div class="price-section">
                            <span class="price">‚Çπ{{ crop.price_per_kg }}/kg</span>
                            <span class="total-price"><span data-translate="buy.total">Total:</span> ‚Çπ{{ "{:,.0f}".format(crop.total_price) }}</span>
                        </div>
                        <div class="crop-actions">
                            {% if crop.seller_email == user_email %}
                                <!-- Show edit/delete buttons for own listings -->
                                <button class="btn-edit" onclick="editCrop('{{ crop._id }}')">‚úèÔ∏è <span data-translate="buy.edit">Edit</span></button>
                                <button class="btn-delete" onclick="deleteCrop('{{ crop._id }}')">üóëÔ∏è <span data-translate="buy.delete">Delete</span></button>
                            {% else %}
                                <!-- Show buy/contact buttons for other users' listings -->
                                {% if crop.quantity == 0 or not crop.is_active %}
                                <button class="btn-contact" onclick="contactSeller('{{ crop.seller_phone }}', '{{ crop.name }}')" style="width: 100%;">üìû <span data-translate="buy.contactSeller">Contact Seller</span></button>
                                {% else %}
                                <button class="btn-contact" onclick="contactSeller('{{ crop.seller_phone }}', '{{ crop.name }}')">üìû <span data-translate="buy.contactSeller">Contact Seller</span></button>
                                <button class="btn-buy" onclick="buyCrop('{{ crop._id }}')">üõí <span data-translate="buy.buyNow">Buy Now</span></button>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="no-crops">
                    <div class="no-crops-icon">üå±</div>
                    <h3 data-translate="buy.noCrops">No crops available</h3>
                    <p data-translate="buy.checkBack">Check back later for new crop listings!</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function applyFilters() {
    const category = document.getElementById('category-filter').value;
    const price = document.getElementById('price-filter').value;
    const location = document.getElementById('location-filter').value;
    
    // Build query parameters
    const params = new URLSearchParams();
    if (category) params.append('category', category);
    if (location) params.append('location', location);
    if (price) {
        const [min, max] = price.split('-');
        if (min) params.append('price_min', min);
        if (max) params.append('price_max', max);
    }
    
    // Reload page with filters
    window.location.href = `/buy?${params.toString()}`;
}

function contactSeller(phone, cropName) {
    const message = `Hi! I'm interested in buying your ${cropName}. Please contact me back.`;
    const whatsappUrl = `https://wa.me/${phone.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(message)}`;
    
    if (confirm(`Contact ${cropName} seller?\n\nPhone: ${phone}\n\nOpen WhatsApp?`)) {
        window.open(whatsappUrl, '_blank');
    }
}

async function buyCrop(cropId) {
    try {
        // Fetch crop details from API
        const response = await fetch(`/api/crops`);
        const data = await response.json();
        
        if (!data.success) {
            alert('Error: Could not fetch crop details');
            return;
        }
        
        // Find the crop by ID
        const crop = data.crops.find(c => c._id === cropId);
        
        if (!crop) {
            alert('Crop not found');
            return;
        }
        
        // Check if crop is available
        if (!crop.is_active || crop.quantity === 0) {
            alert('This crop is sold out and no longer available');
            location.reload(); // Refresh to update UI
            return;
        }
        
        // Ask user for quantity
        const maxQuantity = crop.quantity;
        const quantity = prompt(`Enter quantity (kg) to purchase (Available: ${maxQuantity} kg):`, '1');
        
        if (!quantity || isNaN(quantity) || quantity <= 0) {
            return; // User cancelled or invalid input
        }
        
        const qty = parseFloat(quantity);
        
        if (qty > maxQuantity) {
            alert(`Sorry, only ${maxQuantity} kg available`);
            return;
        }
        
        // Calculate total amount
        const totalAmount = crop.price_per_kg * qty;
        
        // Confirm purchase
        const confirmMsg = `Purchase Details:\n\n` +
            `Crop: ${crop.name}\n` +
            `Quantity: ${qty} kg\n` +
            `Price per kg: ‚Çπ${crop.price_per_kg}\n` +
            `Total Amount: ‚Çπ${totalAmount.toFixed(2)}\n\n` +
            `Proceed to payment?`;
        
        if (!confirm(confirmMsg)) {
            return; // User cancelled
        }
        
        // Initiate Razorpay payment
        if (typeof initiatePayment === 'function') {
            await initiatePayment(
                totalAmount, 
                `Purchase ${qty} kg of ${crop.name}`,
                {
                    crop_id: cropId,
                    crop_name: crop.name,
                    quantity: qty,
                    price_per_kg: crop.price_per_kg,
                    seller_email: crop.seller_email,
                    seller_name: crop.seller_name
                }
            );
        } else {
            alert('Payment system is not available. Please try again later.');
            console.error('initiatePayment function not found. Make sure payment.js is loaded.');
        }
        
    } catch (error) {
        console.error('Error in buyCrop:', error);
        alert('An error occurred while processing your purchase. Please try again.');
    }
}

function editCrop(cropId) {
    // For now, just show an alert. In a real app, you'd open an edit modal
    alert('Edit functionality will be implemented. Crop ID: ' + cropId);
}

function deleteCrop(cropId) {
    if (confirm('Are you sure you want to delete this crop listing?')) {
        fetch(`/api/crops/${cropId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Crop listing deleted successfully!');
                location.reload(); // Refresh to update listings
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while deleting the crop.');
        });
    }
}
</script>
{% endblock %}
